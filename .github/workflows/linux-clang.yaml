name: Linux Clang

on:
    push:
        branches:
            - main
            - dev
    pull_request:
        branches:
            - main
            - dev
    workflow_dispatch:

# Cancel in-progress runs for the same PR/branch
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build-linux-clang:
        name: Linux Clang (${{ matrix.build_type }})
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                build_type: [debug, release]
                include:
                    - build_type: debug
                      cmake_type: Debug
                    - build_type: release
                      cmake_type: Release

        env:
            CC: clang
            CXX: clang++

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  submodules: recursive
                  fetch-depth: 0

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install system dependencies
              run: |
                  wget https://apt.llvm.org/llvm.sh
                  chmod +x llvm.sh
                  sudo ./llvm.sh 19
                  sudo apt-get update
                  sudo apt-get install -y \
                    libc++-19-dev \
                    libc++abi-19-dev \
                    cmake \
                    ninja-build \
                    python3 \
                    python3-pip
                  sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-19 190
                  sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-19 190

            - name: Install project dependencies
              run: |
                  python3 scripts/install_deps.py --use-system --no-interactive

            - name: Configure CMake
              run: |
                  python3 scripts/configure.py \
                    --compiler clang \
                    --type ${{ matrix.cmake_type }} \
                    --build-system Ninja \
                    --no-interactive

            - name: Build
              run: |
                  python3 scripts/build.py \
                    --compiler clang \
                    --type ${{ matrix.cmake_type }} \
                    --build-system Ninja \
                    --tests \
                    --no-examples \
                    --no-interactive

            - name: Run Tests
              working-directory: build/${{ matrix.build_type }}/linux
              run: |
                  ctest --output-on-failure --parallel 2

            - name: Upload Test Results
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: test-results-linux-clang-${{ matrix.build_type }}
                  path: build/${{ matrix.build_type }}/linux/Testing/
