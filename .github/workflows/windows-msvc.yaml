name: Windows MSVC

on:
    push:
        branches:
            - main
            - dev
    pull_request:
        branches:
            - main
            - dev
    workflow_dispatch:

# Cancel in-progress runs for the same PR/branch
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build-windows-msvc:
        name: Windows MSVC (${{ matrix.build_type }})
        runs-on: windows-latest
        strategy:
            fail-fast: false
            matrix:
                build_type: [debug, release]
                include:
                    - build_type: debug
                      cmake_type: Debug
                    - build_type: release
                      cmake_type: Release

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  submodules: recursive
                  fetch-depth: 0

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Setup MSVC
              uses: ilammy/msvc-dev-cmd@v1
              with:
                  arch: x64

            - name: Install project dependencies
              run: |
                  python scripts/install_deps.py --use-conan --build-type ${{ matrix.cmake_type }} --no-interactive

            - name: Configure CMake
              run: |
                  python scripts/configure.py `
                    --compiler cl `
                    --type ${{ matrix.cmake_type }} `
                    --build-system Ninja `
                    --use-conan `
                    --no-interactive

            - name: Build
              run: |
                  python scripts/build.py `
                    --compiler cl `
                    --type ${{ matrix.cmake_type }} `
                    --build-system Ninja `
                    --tests `
                    --no-examples `
                    --use-conan `
                    --no-interactive

            - name: Run Tests
              working-directory: build/${{ matrix.build_type }}/windows
              run: |
                  ctest --output-on-failure --parallel 2

            - name: Upload Test Results
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: test-results-windows-msvc-${{ matrix.build_type }}
                  path: build/${{ matrix.build_type }}/windows/Testing/
